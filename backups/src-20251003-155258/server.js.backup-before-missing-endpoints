require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const compression = require('compression');
const session = require('express-session');
const path = require('path');
const { sequelize } = require('./models');
const logger = require('./utils/logger');

// Import routers
const authRouter = require('./api/auth');
const alertsRouter = require('./api/alerts');
const reportsRouter = require('./api/reports');
const adminRouter = require('./api/admin');

const app = express();
const PORT = process.env.PORT || 3000;

// Session configuration without Redis for now

// Security middleware - disabled for development
app.use(helmet({
  contentSecurityPolicy: false, // Disable CSP completely for now
  crossOriginOpenerPolicy: false,
  originAgentCluster: false,
  strictTransportSecurity: false,
}));

// CORS configuration
app.use(cors({
  origin: function(origin, callback) {
    // Allow requests with no origin (like mobile apps or curl requests)
    if (!origin) return callback(null, true);
    
    // Allow all origins for now (you should restrict this in production)
    return callback(null, true);
  },
  credentials: true,
}));

// Compression
app.use(compression());

// Body parsing
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Session configuration
app.use(session({
  secret: process.env.SESSION_SECRET || 'franciscomoney-session-secret-key-2025',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: false, // Set to false for HTTP
    httpOnly: true,
    maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days
  },
}));

// Static files
app.use(express.static(path.join(__dirname, '..', 'public')));

// View engine setup
app.set('views', path.join(__dirname, '..', 'views'));
app.set('view engine', 'ejs');

// API Routes
app.use('/api/auth', authRouter);
app.use('/api/alerts', alertsRouter);
app.use('/api/reports', reportsRouter);
app.use('/api/admin', adminRouter);

// Tracking routes (must be imported after models are initialized)
const trackingRouter = require('./api/tracking');
app.use('/api/tracking', trackingRouter);

// Landing page
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'index.html'));
});

// Login page
app.get('/login', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'login.html'));
});

// User dashboard
app.get('/dashboard', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'dashboard.html'));
});

// Reports page
app.get('/reports', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'reports.html'));
});

// Logout redirect
app.get('/logout', async (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      logger.error('Error destroying session:', err);
    }
    res.redirect('/login');
  });
});

// Admin dashboard
app.get('/admin', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'admin.html'));
});

// Register page
app.get('/register', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'register.html'));
});

// Test page
app.get('/test', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'public', 'test.html'));
});

// Report pages (SEO-optimized)
app.get('/reports/:topic/:slug', (req, res) => {
  // This will be implemented to serve SEO-optimized report pages
  res.render('report', { topic: req.params.topic, slug: req.params.slug });
});

// Official document HTML pages (e.g., /A001.html)
app.get('/:code.html', async (req, res) => {
  try {
    const { Document } = require('./models');
    const document = await Document.findOne({
      where: { code: req.params.code },
      include: [{
        model: require('./models').Source,
        as: 'source',
        include: [{
          model: require('./models').TopicArea,
          as: 'topicArea'
        }]
      }]
    });
    
    if (!document) {
      return res.status(404).send('Document not found');
    }
    
    // Generate Business Insider style HTML page
    const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.title} | Franciscomoney Intel</title>
    <meta name="description" content="${document.aiAnalysis?.summary || document.title}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            line-height: 1.6; 
            color: #111;
            background: #fff;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 900;
            color: #0066cc;
            text-decoration: none;
            display: inline-block;
        }
        
        .article-meta {
            margin: 40px 0 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .category {
            color: #0066cc;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        h1 {
            font-size: 42px;
            line-height: 1.2;
            font-weight: 900;
            margin: 15px 0 20px;
            color: #111;
        }
        
        .byline {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .byline .author {
            font-weight: 500;
            color: #111;
        }
        
        .date {
            font-size: 14px;
            color: #666;
        }
        
        .key-takeaways {
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
            padding: 25px 30px;
            margin: 30px 0;
        }
        
        .key-takeaways h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .key-takeaways ul {
            list-style: none;
            padding: 0;
        }
        
        .key-takeaways li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .key-takeaways li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #0066cc;
            font-weight: bold;
            font-size: 20px;
            line-height: 20px;
        }
        
        .article-content {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin: 40px 0;
        }
        
        .article-content p {
            margin-bottom: 24px;
        }
        
        .article-content h2 {
            font-size: 28px;
            font-weight: 700;
            margin: 40px 0 20px;
            color: #111;
        }
        
        .metrics {
            display: flex;
            gap: 40px;
            margin: 40px 0;
            padding: 30px 0;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .metric {
            text-align: center;
            flex: 1;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 900;
            color: #0066cc;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .themes-section {
            margin: 40px 0;
        }
        
        .themes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .theme-tag {
            display: inline-block;
            padding: 8px 16px;
            background: #f0f4f8;
            color: #333;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .footer {
            margin-top: 60px;
            padding: 40px 0;
            border-top: 1px solid #e5e5e5;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .original-link {
            margin-top: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .original-link a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }
        
        .original-link a:hover {
            text-decoration: underline;
        }
        
        .why-read {
            background: #f0f8ff;
            border-left: 4px solid #0066cc;
            padding: 20px 25px;
            margin: 30px 0;
        }
        
        .why-read h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #0066cc;
        }
        
        .why-read p {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin: 0;
        }
        
        .analysis-section {
            margin: 50px 0;
        }
        
        .analysis-section h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #111;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 10px;
        }
        
        .highlight-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 25px;
        }
        
        .highlight-box p {
            font-size: 16px;
            line-height: 1.7;
            margin-bottom: 15px;
        }
        
        .highlight-box p:last-child {
            margin-bottom: 0;
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .insight-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .insight-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #0066cc;
        }
        
        .insight-card p {
            font-size: 15px;
            line-height: 1.6;
            color: #444;
        }
        
        .risk-analysis {
            background: #fff5f5;
            border: 1px solid #ffdddd;
            border-radius: 8px;
            padding: 25px;
        }
        
        .risk-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ffdddd;
        }
        
        .risk-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .risk-item h4 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #d32f2f;
        }
        
        .risk-item p {
            font-size: 15px;
            line-height: 1.6;
            color: #444;
        }
        
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .timeline-item {
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
            padding: 20px;
        }
        
        .timeline-item h4 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0066cc;
        }
        
        .timeline-item p {
            font-size: 15px;
            line-height: 1.6;
            color: #444;
        }
        
        .action-items {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 25px;
        }
        
        .action-items p {
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 12px;
            color: #333;
        }
        
        .action-items p:last-child {
            margin-bottom: 0;
        }
        
        .facts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .fact-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #0066cc;
        }
        
        .fact-number {
            background: #0066cc;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .fact-item p {
            margin: 0;
            line-height: 1.6;
            color: #333;
        }
        
        .document-content {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .document-content p {
            margin-bottom: 20px;
            color: #333;
        }
        
        .document-content p:last-child {
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 32px; }
            .article-content { font-size: 16px; }
            .metrics { flex-direction: column; gap: 20px; }
            .key-takeaways { padding: 20px; }
            .why-read { padding: 20px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">Franciscomoney Intel</a>
        </div>
    </header>

    <main class="container">
        <article>
            <div class="article-meta">
                <span class="category">${document.source?.topicArea?.name || 'Intelligence Report'}</span>
                <h1>${document.title}</h1>
                <div class="byline">
                    Analysis by <span class="author">Franciscomoney AI</span> ‚Ä¢ Source: ${document.source?.name || 'Research'}
                </div>
                <div class="date">
                    ${document.processedAt ? new Date(document.processedAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) : new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}
                </div>
            </div>

            ${document.aiAnalysis?.facts && document.aiAnalysis.facts.length > 0 ? `
            <div class="key-takeaways">
                <h2>Key Takeaways</h2>
                <ul>
                    ${document.aiAnalysis.facts.slice(0, 5).map(fact => `<li>${fact}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${document.aiAnalysis ? `
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value">${document.aiAnalysis.relevanceScore || 'N/A'}</div>
                    <div class="metric-label">Relevance Score</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${document.aiAnalysis.sentiment || 'Neutral'}</div>
                    <div class="metric-label">Sentiment</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${document.aiAnalysis.urgency || 'Medium'}</div>
                    <div class="metric-label">Urgency Level</div>
                </div>
            </div>
            ` : ''}

            ${document.aiAnalysis?.summary || document.markdownContent ? `
            <div class="why-read">
                <h2>Why This Matters</h2>
                <p>I selected this ${document.source?.topicArea?.name || 'intelligence'} report because ${
                    document.title.toLowerCase().includes('tokenization') || document.title.toLowerCase().includes('tokenisation')
                    ? 'tokenization could fundamentally reshape how $100+ trillion in global assets are traded, owned, and managed. The FSB\'s analysis reveals both massive opportunities and critical risks that every financial professional needs to understand'
                    : 'it addresses game-changing developments in financial technology that could transform traditional markets'
                }.</p>
            </div>
            ` : ''}

            ${document.aiAnalysis ? `
            <div class="analysis-section">
                <h2>üìä AI Analysis Summary</h2>
                <div class="highlight-box">
                    ${document.aiAnalysis.summary ? `<p>${document.aiAnalysis.summary}</p>` : ''}
                </div>
            </div>
            ` : ''}

            ${document.aiAnalysis?.facts && document.aiAnalysis.facts.length > 0 ? `
            <div class="analysis-section">
                <h2>üìå Key Facts from Document</h2>
                <div class="facts-list">
                    ${document.aiAnalysis.facts.map((fact, index) => `
                        <div class="fact-item">
                            <span class="fact-number">${index + 1}</span>
                            <p>${fact}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}


            ${document.aiAnalysis?.themes && document.aiAnalysis.themes.length > 0 ? `
            <div class="themes-section">
                <h2>Related Topics</h2>
                <div class="themes">
                    ${document.aiAnalysis.themes.map(theme => 
                        `<span class="theme-tag">${theme}</span>`
                    ).join('')}
                </div>
            </div>
            ` : ''}

            ${document.pdfUrl ? `
            <div class="original-link">
                <a href="${document.pdfUrl}" target="_blank" rel="noopener noreferrer">
                    Download Original PDF ‚Üí
                </a>
            </div>
            ` : ''}
        </article>
    </main>

    <footer class="footer">
        <div class="container">
            <p>¬© ${new Date().getFullYear()} Franciscomoney Intel. AI-powered intelligence for better decisions.</p>
        </div>
    </footer>
</body>
</html>`;
    
    res.send(html);
  } catch (error) {
    logger.error('Error serving document HTML:', error);
    res.status(500).send('Internal server error');
  }
});

// Download markdown endpoint
app.get('/api/documents/:id/markdown', async (req, res) => {
  try {
    const { Document } = require('./models');
    const document = await Document.findByPk(req.params.id);
    
    if (!document) {
      return res.status(404).json({ error: 'Document not found' });
    }
    
    res.setHeader('Content-Type', 'text/markdown');
    res.setHeader('Content-Disposition', `attachment; filename="${document.code || document.id}.md"`);
    res.send(document.markdownContent || '# No content available');
  } catch (error) {
    logger.error('Error downloading markdown:', error);
    res.status(500).json({ error: 'Failed to download markdown' });
  }
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date(),
    uptime: process.uptime(),
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  logger.error('Unhandled error:', err);
  res.status(err.status || 500).json({
    error: process.env.NODE_ENV === 'production' 
      ? 'Internal server error' 
      : err.message,
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found' });
});

// Start server
async function startServer() {
  try {
    // Test database connection
    logger.info('Testing database connection...');
    await sequelize.authenticate();
    logger.info('Database connection established successfully');
    
    // Sync database models
    logger.info('Syncing database models...');
    await sequelize.sync({ force: false });
    logger.info('Database models synchronized');
    
    // Create admin user if it doesn't exist
    const createAdminUser = require('../scripts/createAdmin');
    await createAdminUser();
    logger.info('Admin user checked/created');
    
    // Start listening
    app.listen(PORT, () => {
      logger.info(`Franciscomoney Intel server running on port ${PORT}`);
      logger.info(`Admin: http://155.138.165.47:3000/admin`);
      logger.info(`Registration: http://155.138.165.47:3000/register`);
    });
  } catch (error) {
    logger.error('Failed to start server:', error);
    process.exit(1);
  }
}

startServer();

module.exports = app;
// ========================================
// TEST DISCOVERY ENDPOINTS
// ========================================

/**
 * Test Endpoint 1: Create Temporary Topic Area
 */
app.post('/api/test/create-temp-topic', async (req, res) => {
  try {
    const { name, keywords } = req.body;

    // Create temporary topic area
    const topicArea = await models.TopicArea.create({
      name: `[TEST] ${name}`,
      description: `Temporary test topic created at ${new Date().toISOString()}`,
      keywords: typeof keywords === 'string' ? keywords.split(',').map(k => k.trim()) : keywords,
      isActive: true
    });

    res.json({
      success: true,
      topicAreaId: topicArea.id,
      message: 'Temporary topic created'
    });

  } catch (error) {
    console.error('Error creating temp topic:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * Test Endpoint 2: Generate Email Content
 */
app.post('/api/test/generate-email', async (req, res) => {
  try {
    const { topicAreaId, topicName, sources, recipientEmail } = req.body;

    if (!sources || sources.length === 0) {
      const html = `
<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; padding: 40px; background: #f3f4f6;">
  <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px;">
    <h1 style="color: #111827;">No New Reports Found</h1>
    <p style="color: #6b7280;">We searched for "${topicName}" but didn't find any publications.</p>
  </div>
</body>
</html>`;
      return res.json({
        success: true,
        subject: `Test Alert: ${topicName}`,
        html
      });
    }

    // Process sources
    const processedSources = sources.slice(0, 5).map((source, index) => {
      const summary = source.settings?.description || source.name || 'No description available';
      const relevanceScore = source.settings?.relevanceScore || 0.75;
      const impactScore = Math.round(relevanceScore * 10);

      return {
        index: index + 1,
        title: source.name || source.title || 'Untitled',
        url: source.url,
        summary,
        impactScore,
        impactCircles: '‚óè'.repeat(impactScore) + '‚óã'.repeat(10 - impactScore),
        organization: source.settings?.organization || 'Unknown',
        publishedAt: source.settings?.publishedAt || new Date()
      };
    });

    // Generate HTML email
    const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your ${topicName} Intelligence Brief</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f3f4f6;">
  <table role="presentation" style="width: 100%; border-collapse: collapse;">
    <tr>
      <td style="padding: 40px 20px;">
        <table role="presentation" style="max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          
          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); padding: 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">Franciscomoney Intel</h1>
              <p style="margin: 10px 0 0 0; color: #9ca3af; font-size: 14px;">AI-Powered Intelligence Briefing</p>
            </td>
          </tr>

          <!-- Intro -->
          <tr>
            <td style="padding: 30px 30px 20px 30px;">
              <h2 style="margin: 0 0 10px 0; color: #111827; font-size: 20px; font-weight: 600;">Your ${topicName} Brief</h2>
              <p style="margin: 0; color: #6b7280; font-size: 14px; line-height: 1.6;">
                We've analyzed the latest research and found ${processedSources.length} key ${processedSources.length === 1 ? 'report' : 'reports'} relevant to your interests:
              </p>
            </td>
          </tr>

          <!-- Reports -->
          ${processedSources.map(source => `
          <tr>
            <td style="padding: 0 30px 25px 30px;">
              <div style="background-color: #f9fafb; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 4px;">
                <div style="margin-bottom: 12px;">
                  <span style="display: inline-block; background-color: #3b82f6; color: #ffffff; font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">${source.index}</span>
                  <strong style="color: #111827; font-size: 16px;">${source.title}</strong>
                </div>
                <div style="margin-bottom: 12px; font-size: 13px; color: #6b7280;">
                  <strong>${source.organization}</strong>${source.publishedAt ? ` ‚Ä¢ ${new Date(source.publishedAt).toLocaleDateString()}` : ''}
                </div>
                <p style="margin: 0 0 12px 0; color: #374151; font-size: 14px; line-height: 1.6;">${source.summary}</p>
                <div style="margin-bottom: 12px;">
                  <span style="font-size: 12px; color: #6b7280; font-weight: 600; margin-right: 8px;">IMPACT:</span>
                  <span style="color: #3b82f6; font-size: 14px; letter-spacing: 2px;">${source.impactCircles}</span>
                  <span style="font-size: 12px; color: #6b7280; margin-left: 4px;">${source.impactScore}/10</span>
                </div>
                <a href="${source.url}" style="display: inline-block; background-color: #3b82f6; color: #ffffff; text-decoration: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; font-weight: 500;">Read Full Analysis ‚Üí</a>
              </div>
            </td>
          </tr>
          `).join('')}

          <!-- Footer -->
          <tr>
            <td style="background-color: #f9fafb; padding: 30px; text-align: center; border-top: 1px solid #e5e7eb;">
              <p style="margin: 0 0 10px 0; color: #6b7280; font-size: 13px;">
                You're receiving this because you created an alert for "${topicName}"
              </p>
              <p style="margin: 15px 0 0 0; color: #9ca3af; font-size: 11px;">¬© ${new Date().getFullYear()} Franciscomoney Intel</p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

    const subject = `Your ${topicName} Intelligence Brief - Test`;

    res.json({
      success: true,
      subject,
      html
    });

  } catch (error) {
    console.error('Error generating email:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * Test Endpoint 3: Send Test Email
 */
app.post('/api/test/send-test-email', async (req, res) => {
  try {
    const { to, subject, html } = req.body;
    const emailService = require('./services/emailService');

    // Add test banner
    const testHtml = `
      <div style="padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <strong style="color: #92400e; font-size: 16px;">‚ö†Ô∏è This is a Test Email</strong>
        <p style="margin: 5px 0 0 0; color: #92400e; font-size: 14px;">
          This email was generated by the admin test feature. Production emails will not have this banner.
        </p>
      </div>
      ${html}
    `;

    const result = await emailService.sendEmail({
      to,
      subject: `[TEST] ${subject}`,
      html: testHtml
    });

    res.json({
      success: true,
      messageId: result.messageId,
      message: 'Test email sent successfully'
    });

  } catch (error) {
    console.error('Error sending test email:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

/**
 * Test Endpoint 4: Cleanup Temporary Topic
 */
app.delete('/api/test/cleanup-temp-topic/:topicAreaId', async (req, res) => {
  try {
    const { topicAreaId } = req.params;

    // Delete associated sources
    await models.Source.destroy({
      where: { topicAreaId }
    });

    // Delete topic area
    await models.TopicArea.destroy({
      where: { id: topicAreaId }
    });

    res.json({
      success: true,
      message: 'Temporary topic cleaned up'
    });

  } catch (error) {
    console.error('Error cleaning up temp topic:', error);
    res.status(500).json({ error: error.message });
  }
});

